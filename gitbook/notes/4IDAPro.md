# 恶意代码分析实战四：IDA Pro神器的使用
<meta name="referrer" content="no-referrer"/> 
<!-- toc -->
这节课主要通过使用IDA Pro来进行静态高级分析

## 实验：

```
----------------
Lab05-01.dll
----------------

使用工具：
1. IDA Pro

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
1、DllMain的地址是什么？
2、使用Imports窗口并浏览到的gethostbyname，导入函数定位到什么地址？
3、有多少函数调用了gethostbyname？
4、将精力集中在位于0x10001757处的对gethostbyname的调用，你能找出哪个DNS请求将被触发吗？
5、IDA Pro识别了在0x10001656处的子过程中的多少个局部变量？
6、IDA Pro识别了在0x10001656处的子过程中的多少个参数？
7、使用Strings窗口，来在反汇编中定位字符串\cmd.exe /c 。它位于哪？
8、在引用\cmd.exe /c的代码所在的区域发生了什么？
9、在同一的区域，在0x100101C8处，看起来好像是dword_1008E5C4是一个全局变量，它帮助决定走哪条路径。那恶意代码是如何设置dword_1008E5C4的呢？(提示：使用dword_1008E5C4的交叉引用。)
-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
```



### 题目1：利用IDA Pro分析dll的入口点并显示地址

按照如下步骤打开IDA Pro并且加载dll文件进行分析。

![image-20210816104447048](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816104445140-184611703.png) 

![image-20210816104555256](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816104555816-947610536.png) 

![image-20210816104634494](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816104633883-1055870137.png) 

等待分析完毕后，IDA Pro自动的会显示出dll的入口点函数`dllmain`，如图。

题目1让我们显示出dllmain函数的地址，这里有两种方法，第一种方法是直接按空格切换成文本视图，第二种方法是在设置中显示带地址的图形显示。 

![image-20210816104746502](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816104744957-480242822.png)  

#### 空格切换文本视图：

![image-20210816105000976](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816104959803-1794537836.png) 

#### 带地址显示图形界面

点击菜单 Options->General...->勾上 Line prefixes (graph)

![image-20210816105345486](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816105343930-845268980.png) 

![image-20210816105414962](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816105413858-1436092045.png) 

### 题目2：IDA Pro导入表窗口

在`Imports`窗口中按`ctrl+f`进行搜索输入`gethostbyname`，定位到gethostbyname后双击过去调到文本视图界面看到其地址。

![image-20210816110307586](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816110306035-1827634251.png) 

![image-20210816110608131](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816110607431-642110554.png) 

### 题目3：交叉应用，看多少处函数调用了

在`gethostbyname`处按`ctrl+x`调出`交叉引用`，能看到所有对gethostbyname处有调用读取写入等的所有地方。

点击`Type`进行类型排序，然后我们仔细来看这里有两个Type，一个是`p`代表的是函数,`r`代表的是读取属性，

所以这里一共有9个p，但是这9个p并不能代码是9个函数调用了，我们在仔细来看图2，其中他有很多地址重复的，所以我们按照地址来分一共可以分析出是4处函数调用了gethostbyname。

![image-20210816111105632](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816111104186-499963902.png) 

![image-20210816111304620](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816111303775-965161103.png) 

### 题目4：利用ctrl+g跳转地址

将精力集中在位于0x10001757处的对gethostbyname的调用，你能找出哪个DNS请求将被触发吗？

首先我们用ctrl+c拷贝`0x10001757`这个地址，然后在IDA Pro文本视图或界面视图，按`g`按键，跳转到对应的地址处。

![image-20210816112256669](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816112255949-145256771.png) 

![image-20210816112341517](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816112340299-1431434786.png) 

切换到界面视图，然后对题目4的问题进行分析：你能找出哪个DNS请求将被触发吗？，我们找找gethostbyname的参数，一般call的意思就是调用函数，这里call gethostbyname就是调用gethostbyname这个api函数，然后call上面挨着的push就是函数参数，可以看到这里就一个参数`push eax`，参数是eax，所以我们来看看是什么给eax进行了赋值，往上可以看到有一句`mov eax,off_10019040`，这种带off_或者dword_下划线后面加个地址的可能都是`全局变量`，在后面有个注释是IDA Pro自动加上的，他这里分析出来off_10019040是一个字符串`[This is RDO]pics.praticalmalwareanalys`

![image-20210816112956670](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816112955114-481820878.png) 

我们也可以直接双击全局变量过去，跳到他的定义处，在图一中还有一句`add eax,0Dh`，意思是将eax字符串的指针指向从开头后0xD也就是后13处，那么正好是`pics.praticalmalwareanalys`这个域名被解析。（答案）

![image-20210816113033143](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816113031607-2135903345.png) 

### 题目5：局部变量分析

IDA Pro识别了在0x10001656处的子过程中的多少个局部变量？

首先跳转到地址处，不再重复如何跳转。然后我们在汇编代码的上面可以看到这些东西，红色标记的地方，这些都是局部变量和参数，其中`带负号的`都是局部变量，这里一共有23个带负号的，也就是23个局部变量。

![image-20210816114619883](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816114625959-184048211.png) 

### 题目6：函数参数分析

IDA Pro识别了在0x10001656处的子过程中的多少个参数？

看上面的图，其中`正数`的就是参数，这里只有一个参数`lpThreadParameter`，其实也可以看函数头注释那里，IDA Pro自动分析出了`DWORD __stdcall sub_10001656(LPVOID lpThreadParameter)`,可以看出是一个参数。

### 题目7：Strings字符串窗口

使用Strings窗口，来在反汇编中定位字符串\cmd.exe /c 。它位于哪？

我们可以按`shift+f12`来打开字符串窗口，可以在菜单中点击`View->Open subviews->Strings`打开字符串窗口。

![image-20210816115335485](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816115334023-746650587.png) 

![image-20210816115422773](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816115421364-1346612923.png) 

双击过去之后点击这个地方，然后在图2中可以看到是`0x100101D0`位置的反汇编`push offset aCmdExeC`处。

![image-20210816115504628](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816115503148-600830893.png) 

![image-20210816115756935](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816115755533-544225403.png) 

### 题目8：代码分析

在引用\cmd.exe /c的代码所在的区域发生了什么？

我们在`100101D0`地址处，按一下按键`F5`进入反编译`C++伪代码`进行代码分析。

首先我们在函数开头的地方开始逐步分析，可以看到一些敏感的字符串，这里有个关键字`Remote Shell Session`，所以这个程序应该是一个恶意远程Shell程序。

![image-20210816131035431](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816131036278-140707818.png) 

接着就是用控制命令，远程创建cmd命令来达到执行Shell的目的。

![image-20210816131140039](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816131140522-831968227.png) 

![image-20210816132027587](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816132028053-1280503178.png) 

![image-20210816132157267](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816132157816-39449530.png) 

![image-20210816132317331](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816132317738-927087262.png) 

### 题目9：进阶分析

在同一的区域，在0x100101C8处，看起来好像是dword_1008E5C4是一个全局变量，它帮助决定走哪条路径。那恶意代码是如何设置dword_1008E5C4的呢？(提示：使用dword_1008E5C4的交叉引用。)

跳转到地址，然后点击全局变量，在全局变量位置处按`ctrl+x`调出交叉引用，然后可以看到有w 和r两种属性，其中我们可以知道w就是写入属性，而题目中需要我们来`cmp`走哪条分支，还有如何设置dword_1008E5C4全局变量，那么肯定是要看w属性看是什么东西写入到了全局变量`dword_1008E5C4`。

![image-20210816133055222](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816133055623-349433222.png) 

![image-20210816133213139](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816133213759-1353706750.png) 

可以看到代码处是eax复制给了全局变量`dword_1008E5C4`,而eax来源于上一句call的返回值，所以我们需要继续跟入Call来看他的返回值是什么？

![image-20210816133907012](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816133907565-694390482.png) 

sub_10003695函数功能是获取系统版本信息，并且判断系统版本是否为NT系统，如果是返回true,否则返回false。

![image-20210816134131308](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816134131910-2118603059.png) 

![image-20210816134330714](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816134331286-1820477811.png) 

根据上面的分析我们可以得出结论，dword_1008E5C4的值应该是true也就是不为0，所以他不会跳转到loc_1001d7处，而是继续执行"cmd.exe /c"处。

![image-20210816134724611](https://img2020.cnblogs.com/blog/2080041/202108/2080041-20210816134725363-900334664.png) 

## 总结：

这一节我们学习了IDA Pro的很多知识，主要学会了IDA Pro

- 文本视图和界面视图的切换（用空格按键）
- 在界面视图显示地址
- 查看IDA Pro的导入表窗口
- 交叉引用，查看被多少处函数调用(ctrl + x)
- 地址的跳转(ctrl + g)
- 函数内局部变量的分析（带负号的）
- 函数参数分析(push xx,call xxx)、(正数的)
- Strings 字符串窗口的查看(shift + f12)
- 代码分析(f5)
- 静态分析流程分支，追溯(利用ctrl +x) 看w和r属性，分析函数返回值

